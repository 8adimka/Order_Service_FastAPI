# Обновления системы авторизации

## Исправленные несоответствия

### 1. Добавление refresh token для собственного сервиса

- **Было**: Выдавался только access token
- **Стало**: Выдаются и access token, и refresh token
- **Изменения**:
  - Добавлено поле `refresh_token` в модель User
  - Функция `create_tokens()` генерирует оба токена
  - Все эндпоинты авторизации возвращают refresh token

### 2. Реализация refresh механизма

- **Было**: Нет эндпоинта для обновления токенов
- **Стало**: Добавлен эндпоинт `/auth/refresh/`
- **Изменения**:
  - Создана схема `RefreshTokenRequest`
  - Добавлена функция `validate_refresh_token()`
  - Эндпоинт проверяет refresh token и выдает новые токены

### 3. Устранение проблем с конфигурацией OAuth

- **Было**: Смешанный подход к переменным окружения
- **Стало**: Единый подход через настройки
- **Изменения**:
  - Удалены дублирующие переменные (`OAUTH_GOOGLE_CLIENT_ID` и т.д.)
  - Добавлены поля в `Settings`: `google_client_id`, `google_client_secret`, `google_redirect_uri`
  - Все эндпоинты используют настройки из конфигурации

### 4. Шифрование чувствительных данных

- **Было**: Google refresh token хранился в открытом виде
- **Стало**: Google refresh token шифруется
- **Изменения**:
  - Создан `EncryptionManager` для шифрования/дешифрования
  - Добавлены переменные окружения `ENCRYPTION_SECRET_KEY` и `ENCRYPTION_SALT`
  - Поле `google_refresh_token` переименовано в `encrypted_google_refresh_token`
  - CRUD операции работают с зашифрованными данными

### 5. Использование refresh token от Google

- **Было**: Google refresh token не использовался
- **Стало**: Реализовано обновление Google access token
- **Изменения**:
  - Создан модуль `google_oauth.py`
  - Добавлена функция `refresh_google_access_token()`
  - Добавлена функция `get_google_user_info()`
  - Добавлен эндпоинт `/auth/google/refresh-info/`

### 6. Унификация схем ответов

- **Было**: Разные схемы для разных эндпоинтов
- **Стало**: Единая схема `AuthResponse`
- **Изменения**:
  - Создана схема `AuthResponse` с полями: `id`, `email`, `full_name`, `picture_url`, `auth_provider`, `access_token`, `refresh_token`, `token_type`
  - Все эндпоинты используют единую схему ответа
  - Удалена старая схема `TokenResponse`

### 7. Улучшение обработки ошибок и логирования

- **Было**: Базовое логирование
- **Стало**: Детальное логирование всех операций
- **Изменения**:
  - Добавлено логирование для всех критических операций
  - Улучшена обработка ошибок OAuth
  - Добавлена валидация всех входных параметров

## Новые эндпоинты

### 1. `POST /auth/refresh/`

- **Назначение**: Обновление access и refresh токенов
- **Входные данные**: `{"refresh_token": "string"}`
- **Выходные данные**: `AuthResponse`
- **Описание**: Принимает валидный refresh token и выдает новые access и refresh токены

### 2. `POST /auth/google/refresh-info/`

- **Назначение**: Обновление информации о пользователе из Google
- **Требуется**: Access token в заголовке Authorization
- **Выходные данные**: `UserOut`
- **Описание**: Использует сохраненный Google refresh token для получения новой информации о пользователе и обновляет ее в базе данных

## Изменения в базе данных

### Миграция `0002_add_refresh_tokens`

1. Добавлено поле `encrypted_google_refresh_token` (Text, nullable)
2. Добавлено поле `refresh_token` (String, nullable)  
3. Удалено поле `google_refresh_token`

## Конфигурация

### Новые переменные окружения

- `ENCRYPTION_SECRET_KEY` - секретный ключ для шифрования
- `ENCRYPTION_SALT` - соль для шифрования
- `ACCESS_TOKEN_EXPIRE_MINUTES` - время жизни access token (по умолчанию 30)
- `REFRESH_TOKEN_EXPIRE_DAYS` - время жизни refresh token (по умолчанию 7)

### Обновленные переменные

- Удалены дублирующие переменные Google OAuth
- Все настройки Google OAuth теперь через `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GOOGLE_REDIRECT_URI`

## Безопасность

1. **Шифрование**: Все чувствительные данные (Google refresh token) шифруются
2. **CSRF защита**: Сохраняется защита через state параметр в OAuth
3. **JWT токены**: Используется RS256 алгоритм с приватным/публичным ключами
4. **Refresh token**: Хранятся в базе данных и валидируются при использовании

## Обратная совместимость

1. **Схемы ответов**: Старые клиенты могут работать с новыми эндпоинтами
2. **База данных**: Миграция обновляет структуру без потери данных
3. **API**: Все старые эндпоинты сохраняют свою функциональность

## Тестирование

Рекомендуется протестировать:

1. Регистрацию и логин с получением refresh token
2. Обновление токенов через `/auth/refresh/`
3. OAuth авторизацию через Google
4. Обновление информации пользователя через `/auth/google/refresh-info/`
5. Валидацию access token в сервисе orders
